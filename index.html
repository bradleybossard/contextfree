<html>
	<head>
	  <title>ContextFree.js</title>
		<style>
		  textarea {display: none;}
      #choose{ float:right; } code{ font-weight: bold; }
		  .background{ width: 100%; background-color: #cacaca; position: absolute; left: 0px; padding-top: 5px; border-top: 1px solid #666;}
		  .padding{ padding: 20px; }
	  </style>


  </head>

<body>
  <div id="canvasContainer" style="width:1200px;height:1000px;"></div>

<div class="background">
  <div class="padding">
  <div id="choose">
    <code>Choose a program:</code><br/>
    <select id="menu" multiple="multiple"></select>
  </div>

<input type="button" value="Redraw" onclick="drawChoice();"/> <code>(You can also use Command-R)</code>
<pre id="theCode"></pre>
</div>
</div>

<textarea id="mtree">
startshape scale

rule scale{
	PLANT { s .08 y -1.2 }
}

rule PLANT {
	EITHER {x -2}
	EITHER {x 2}
}

rule BOTH {
	BL {rotate 30}
	BL {rotate -30 flip 90}
}

rule EITHER {BL{}}
rule EITHER {BL{flip 90}}

rule BL {
	CIRCLE {}
	WL {s 0.95 y 1.6}
}

rule WL {BL {rotate 3}}
rule WL {BL {rotate 4}}
rule WL {BL {rotate 5}}
rule WL {BL {rotate 6}}
rule WL {BL {rotate 7}}
rule WL {BL {rotate 3}}
rule WL {BL {rotate 4}}
rule WL {BL {rotate 5}}
rule WL {BL {rotate 6}}
rule WL {BL {rotate 7}}
rule WL {BOTH {}}
rule WL {BL {rotate -10 flip 90}}	
</textarea>	


<textarea id="circle">
startshape c

rule c{
  CIRCLE{ s 3 }
  c{ s .5 b .5 r 10 x 1}
}

rule c{
  c { s .5}
  c { s .5 flip 100 }
} 
</textarea>

<textarea id="squares and circles" style="width:400px;height:400px">
startshape scale
background{ b -1 }

rule scale{
  c{ s .8 b 1 }
}

rule c {
	SQUARE{ r 3 }
	CIRCLE{ y 1 s .5 }
	CIRCLE{ x 1 s .5 }
	CIRCLE{ x -1 }	
	SQUARE{ y -3 s 1.2 r 45}
	c { x -2 s .5 r 5 }		
}

rule c .3 {
	CIRCLE{ }
}

rule c .2 {
	c{ rotate -10 s .1}
}


</textarea>


<script src="contextfree.js"></script>
<script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>		

<script>
function display( id ){
  // We need to unescape the id because it is coming in via the hash, and
  // URL can have weird encodings (i.e., "%20" instead of " ").
  var theId = unescape(id);
  document.getElementById("theCode").innerHTML = document.getElementById(theId).value;

  var t = new Tokenizer();
  var tokens = t.tokenize( theId );

  var c = new Compiler();
  var compiled = c.compile( tokens );

  if( compiled.background ){
    var back = compiled.background;
    var backcolor = hsl2rgb( back.h|.001, back.sat|.01, back.b|1, back.a|1 );
    document.body.style.backgroundColor = backcolor;
  }

  var canvas = document.createElement( "canvas" );
  var container = $("#canvasContainer");
  canvas.width = container.width();
  canvas.height = container.height();
  canvas.id = "theCanvas";

  $(container).find("#theCanvas").remove();
  $(container).append( canvas );

  var r = Renderer;
  r.render( compiled, "theCanvas" );
}

function drawChoice(){
  var toDisplay = $("#menu option:selected" ).text();
  //location.assign( "#" + toDisplay );
  //location.reload();
  display(toDisplay);
}

function populateMenu( selected ){
  $.get("patterns2.json", function (data) {
    var body = $('body');
    $.each(data, function(key, value) {
      $('<textarea></textarea>').attr('id', key).val(value).appendTo(body);
    });

    $("textarea").each( function() {
      var option = document.createElement("option");
      $(option)
        .attr( "value", this.id )
        .text( this.id )
        if( this.id == selected ){
          // Using jQuery to do:
          //   $(option).attr("selected","true");
          // causes Safari to die.
          option.selected = true;
        }
      $("#menu").append( option );
    });
  },'json');
}
</script>

<script>
if( location.hash ){
  var theId = location.hash.substring(1)
}
else {
  var theId = "mtree";
}
populateMenu( theId );
display( theId );
$("#menu").change( drawChoice );
</script>

</body>
</html>
