<html>
	<head>
	  <title>ContextFree.js</title>
		<style>
		  textarea {display: none;} #choose{ float:right; } code{ font-weight: bold; }
		  .background{ width: 100%; background-color: #cacaca; position: absolute; left: 0px; padding-top: 5px; border-top: 1px solid #666;}
		  .padding{ padding: 20px; }
	  </style>
		<script src="contextfree.js"></script>
		<script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>		
		
		<script>
    //function display( id ){
    function render(cfdg) {
      // We need to unescape the id because it is coming in via the hash, and
      // URL can have weird encodings (i.e., "%20" instead of " ").
      //var theId = unescape(id);
    	//document.getElementById("theCode").innerHTML = document.getElementById(theId).value;

      var t = new Tokenizer();
      var tokens = t.tokenize(cfdg);
      console.log('tokens.length = ' + tokens.length);

      var c = new Compiler();
      var compiled = c.compile(tokens);
/*
    	var t = new Tokenizer();
    	var tokens = t.tokenize( theId );

    	var c = new Compiler();
    	var compiled = c.compile( tokens );
*/
    	
/*
    	if( compiled.background ){
      	var back = compiled.background;
    	  var backcolor = hsl2rgb( back.h|.001, back.sat|.01, back.b|1, back.a|1 );
    	  document.body.style.backgroundColor = backcolor;
    	}
*/

      var canvas = document.createElement( "canvas" );
      var container = $("#canvasContainer");
      canvas.width = container.width();
      canvas.height = container.height();
      canvas.id = "theCanvas";
    
      $(container).find("#theCanvas").remove();
      $(container).append( canvas );

    	var r = Renderer;
    	r.render( compiled, "theCanvas" );
    }
 /*   
    function drawChoice(){
      var toDisplay = $("#menu option:selected" ).text();
      location.assign( "#"+toDisplay );
      location.reload();
    }
    
    function populateMenu( selected ){
      $("textarea").each( function() {
        var option = document.createElement("option");
        $(option)
            .attr( "value", this.id )
            .text( this.id )
        if( this.id == selected ){
          // Using jQuery to do:
          //   $(option).attr("selected","true");
          // causes Safari to die.
          option.selected = true;
        }
        $("#menu").append( option );
      });
    }
*/
		</script>

  </head>

<body>
  <div id="canvasContainer" style="width:1200px;height:1000px;"></div>

<div class="background">
  <div class="padding">
<div id="choose"><code>Choose a program:</code><br/><select id="menu" multiple="multiple"> </select></div>

<input type="button" value="Redraw" onclick="drawChoice();"/> <code>(You can also use Command-R)</code>
<pre></pre>
<pre id="theCode"></pre>
</div>
</div>

<script>



function loadSelect() {
  $.getJSON('cfdgs-pretty.json', function(data) {
    var $menu = $('#menu');
    $.each(data, function(key, value) {
      $('<option></option>')
        .attr('id', key)
        .html(key)
        .val(value)
        /*
        .on('click', function() {
          $('#code').html(value);
          render(value);
        })
        */
        .appendTo(menu);
    });
    $menu.on('change', function() {
      render(this.value);
    });
  });
}


if( location.hash ){ var theId = location.hash.substring(1) }
else{ var theId = "mtree"; }
//populateMenu( theId );
//display( theId );
loadSelect();

</script>

</body>
</html>
